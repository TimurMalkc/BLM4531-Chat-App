@{
    Layout = null;
}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>
        Chat App
    </title>
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.13/signalr.min.js">
    </script>
</head>

<body>
    <div id="mainDiv">
        <div id="roomsDiv">
            <div id="roomsHeadDiv">
                <span id="chatSpan">Your Chats:</span>
            </div>

            <ul class="roomsUl"></ul>
            <div id="roomsFootDiv">
                <button id="profile"></button>
                <button id="settingsButton" class="messageButton">⚙️</button>
                <button id="newGroupBtn">💬➕</button>
            </div>
        </div>

        <div id="subMainDiv">
            <div id="headerDiv">
                <span id="headerSpan"></span>
            </div>

            <div id="chatDiv"></div>

            <div id="messageDiv">
                
                <input type="text" id="messageBar" name="messageBar" placeholder="Enter your message">
                <button id="sendButton" type="submit" class="messageButton">📩</button>
            </div>
        </div>
    </div>

    <div id="authSection">
        <h2>Login</h2>
        <input type="text" id="loginUsername" class="loginInput" placeholder="Username"><br>
        <input type="password" id="loginPassword" class="loginInput" placeholder="Password"><br>
        <button id="loginBtn" class="loginButton">Login</button>
        <button id="registerBtn" class="loginButton">Register</button>
    </div>

    <div id="userInfoPopup">
        <h3>User Info</h3>
        <p><strong>Name:</strong> <span id="infoName"></span></p>
        <p><strong>Last Online:</strong> <span id="infoLastOnline"></span></p>
        <p><strong>Groups:</strong> <span id="infoGroups"></span></p>
        <button id="addUserBtn" style="display:none;">➕👤</button>
        <button id="closeInfoPopup">Close</button>
    </div>



    <script>
        const apiBase = "/api/user";

        let connection = null;
        let currentRoom = null;

        function disconnectIfExists() {
            if (connection) {
                try { connection.stop(); } catch {}
                connection = null;
            }
        }


       
        $("#mainDiv").hide();

       
        $("#registerBtn").click(async () => {
            const username = $("#loginUsername").val();
            const password = $("#loginPassword").val();

            const response = await fetch(apiBase + "/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });

            const text = await response.text();
            alert(text);
        });


        
        $("#loginBtn").click(async () => {
            const username = $("#loginUsername").val();
            const password = $("#loginPassword").val();

            const response = await fetch(apiBase + "/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                sessionStorage.setItem("jwtToken", data.token);

                
                $("#authSection").hide();
                $("#mainDiv").show();

                disconnectIfExists();
                await startChat();
                await loadGroups();
                $("#profile").text(username);

            } else {
                alert("Login failed.");
            }
        });

        $("#authSection").on("keydown", async function(e){
            if (e.key === "Enter") {
                const username = $("#loginUsername").val();
                const password = $("#loginPassword").val();

                const response = await fetch(apiBase + "/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    sessionStorage.setItem("jwtToken", data.token);


                    $("#authSection").hide();
                    $("#mainDiv").show();

                    disconnectIfExists();
                    await startChat();
                    await loadGroups();
                    $("#profile").text(username);

                }else {
                    alert("Login failed.");
                }
            }
        });


       
        
        async function startChat() {
            const token = sessionStorage.getItem("jwtToken");
            console.log("JWT Token before connecting:", token);
            if (!token) return alert("You must log in first!");

            connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub", {
                accessTokenFactory: () => token
            })
            .build();


            connection.on("ReceiveMessage", (user, message, timestamp) => {
                    const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    $("#chatDiv").append(
                        `<p><strong>${user}</strong> [${time}]: ${message}</p>`
                    );
            });

            
            connection.on("LoadChatHistory", messages => {
                $("#chatDiv").empty();
                messages.forEach(m => {
                    const date = new Date(m.timestamp);
                    const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });  
                    if(m.user ==  $("#loginUsername").val()){
                        $("#chatDiv").append(`<p style="text-align: right; padding-right: 10px;"> [${time}]: ${m.message}</p>`);
                    }else{  
                        $("#chatDiv").append(`<p><strong>${m.user}</strong> [${time}]: ${m.message}</p>`);

                    }
                    
                });
            });

                          
            try {
                console.log("Connecting to SignalR...");
                await connection.start();
                        console.log("✅ Connected to SignalR");
            } catch (err) {
                console.error("❌ SignalR failed:", err);
                setTimeout(startChat, 3000);
            }

            
            $("#sendButton").off("click").on("click", async function () {
                if (!currentRoom) return alert("Select a chat first!");
                const message = $("#messageBar").val().trim();
                if (!message) return;

                if (currentRoom.startsWith("#")) {
                    await connection.invoke("SendGroupMessage", currentRoom.substring(1), message);
                } else {
                    await connection.invoke("SendPrivateMessage", currentRoom, message);
                }

                $("#messageBar").val("").focus();
            });

            $("#messageBar").on("keydown", async function(e){
                if (e.key === "Enter") {
                    e.preventDefault();

                    if (!currentRoom) return alert("Select a chat first!");
                
                    
                const message = $(this).val().trim();
                if (!message) return;

                if (currentRoom.startsWith("#")) {
                    await connection.invoke("SendGroupMessage", currentRoom.substring(1), message);
                } else {
                    await connection.invoke("SendPrivateMessage", currentRoom, message);
                }
                    $(this).val("").focus();
                }
            });

        }


        $("#newGroupBtn").click(async () => {
            const groupName = prompt("Enter group name:");
            if (!groupName) return;

            const token = sessionStorage.getItem("jwtToken");

            const response = await fetch("/api/group/create", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                        body: JSON.stringify({ name: groupName })
            });

            if (response.ok) {
                alert("Group created!");
                await loadGroups();
            } else {
                alert("Failed to create group");
                console.log(await response.text());
            }
        });





        async function loadGroups() {
            const token = sessionStorage.getItem("jwtToken");
            if (!token) return;

            const response = await fetch("/api/group", {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!response.ok) return;

            const allGroups = await response.json();

            const tokenPayload = JSON.parse(atob(token.split('.')[1]));
            const currentUser = tokenPayload["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"];

        
            const groups = allGroups.filter(g => g.admin === currentUser || g.members.includes(currentUser));

            const roomsUl = $(".roomsUl");
            roomsUl.empty(); 

            const userResponse = await fetch("/api/userlist/all", {
                headers: { "Authorization": "Bearer " + token }
            });
            if (userResponse.ok) {
                const users = await userResponse.json();
                users.forEach(user => {
                    roomsUl.append(`
                        <li class="roomsLi userLi" data-user="${user.username}">
                            ${user.username}
                        </li>
                    `);
                });

            $(".userLi").off("click").on("click", async function () {
                const otherUser = $(this).data("user");
                if (currentRoom === otherUser) return;

                currentRoom = otherUser;
                $("#chatDiv").empty();
                $("#headerSpan").text("💬 " + otherUser);

                await connection.invoke("JoinPrivateChat", otherUser);
                $("#addUserBtn").hide(); 
                });
            }   


                
            groups.forEach(g => {
                roomsUl.append(`<li class="roomsLi groupLi">#${g.name}</li>`);
            });

                
            $(".groupLi").off("click").on("click", async function () {
                const groupName = $(this).text().replace("#", "");
                currentRoom = "#" + groupName;

                $("#chatDiv").empty();
                $("#headerSpan").text("👥 " + groupName);

                await connection.invoke("JoinRoom", groupName);

                  
                const group = groups.find(gr => gr.name === groupName);
                if (group && group.admin === currentUser) {
                    $("#addUserBtn").show();
                } else {
                    $("#addUserBtn").hide();
                }
            });
        }

        



        async function checkIfAdmin(groupName) {
            const token = sessionStorage.getItem("jwtToken");

            try {
                const response = await fetch(`/api/group/${groupName}`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!response.ok) {
                    console.warn("checkIfAdmin failed, NOT hiding button");
                    return; 
                }

                const group = await response.json();

                const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                const currentUser = tokenPayload["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"];

                if (group.admin === currentUser) {
                    $("#addUserBtn").show();
                } else {
                    $("#addUserBtn").hide();
                }
            }
            catch (err) {
                console.error("checkIfAdmin error:", err);
            }
        }




        $("#addUserBtn").click(async () => {
            if (!currentRoom || !currentRoom.startsWith("#"))
                return alert("Open a group first!");

            const usernameToAdd = prompt("Enter the username you want to add:");
            if (!usernameToAdd) return;

            const groupName = currentRoom.substring(1);
            const token = sessionStorage.getItem("jwtToken");

            const response = await fetch(`/api/group/addUser`, {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    groupName: groupName,
                    username: usernameToAdd
                })
            });

            if (response.ok) {
                alert("User added!");
                loadGroups();
            } else {
                alert("Failed: " + await response.text());
            }
        });


        $("#headerSpan").on("click", async function () {
            const raw = $("#headerSpan").text().trim();
            if (!raw) return;

            const privatePrefix = "💬 ";
            const groupPrefix = "👥 ";

            if (raw.startsWith(privatePrefix)) {
                const username = raw.slice(privatePrefix.length).trim();
                if (!username) return;

                const token = sessionStorage.getItem("jwtToken");
                const res = await fetch(`/api/user/info/${encodeURIComponent(username)}`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!res.ok) {
                    alert("User info not found.");
                    return;
                }

                const data = await res.json();
                $("#infoName").text(data.username ?? username);
                $("#infoLastOnline").text(data.lastOnline ? new Date(data.lastOnline).toLocaleString() : "—");
                $("#infoGroups").text((data.groups && data.groups.length) ? data.groups.join(", ") : "—");
                $("#userInfoPopup").fadeIn(150);
                return;
            }

            
            if (raw.startsWith(groupPrefix)) {
                const groupName = raw.slice(groupPrefix.length).trim();
                if (!groupName) return;

                const token = sessionStorage.getItem("jwtToken");
                const res = await fetch(`/api/group/${encodeURIComponent(groupName)}`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!res.ok) {
                    alert("Group info not found.");
                    return;
                }

                const g = await res.json();
                $("#infoName").text(g.name ?? groupName);
                $("#infoLastOnline").text("—");
                $("#infoGroups").text(`Admin: ${g.admin ?? "—"}\nMembers: ${ (g.members && g.members.length) ? g.members.join(", ") : "—" }`);
                $("#userInfoPopup").fadeIn(150);
                return;
            }

            const username = raw;
            const token = sessionStorage.getItem("jwtToken");
            const res = await fetch(`/api/user/info/${encodeURIComponent(username)}`, {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!res.ok) {
                alert("User info not found.");
                return;
            }

            const data = await res.json();
            $("#infoName").text(data.username ?? username);
            $("#infoLastOnline").text(data.lastOnline ? new Date(data.lastOnline).toLocaleString() : "—");
            $("#infoGroups").text((data.groups && data.groups.length) ? data.groups.join(", ") : "—");
            $("#userInfoPopup").fadeIn(150);
        });


        $("#closeInfoPopup").on("click", function () {
            $("#userInfoPopup").fadeOut(150);
        });


        window.addEventListener("beforeunload", () => {
            try {
                if (connection) connection.stop();
            } catch {}

            const token = sessionStorage.getItem("jwtToken");
            if (!token) return;

            const blob = new Blob([token], { type: "text/plain" });
            navigator.sendBeacon("/api/user/disconnect", blob);
        });

    </script>
</body>

</html>